<!DOCTYPE html>
<html lang="en" style="overflow: hidden;">

<head>
  <meta charset="UTF-8" />
  <title>AI Psychological Sandbox</title>
  <script src="/static/moveable.min.js"></script>
  <script src="/static/html2canvas.min.js"></script>
  <style>
    @font-face {
      font-family: 'Kokonor';
      src: url('/static/Kokonor.ttf') format('truetype');
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Kokonor', sans-serif;
      height: 100vh;
      display: flex;
      background: url('/static/background.jpg') no-repeat center/cover;
    }

    .sidebar {
      width: 160px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      overflow-y: auto;
      border-right: 2px solid #ccc;
      box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
    }

    .item {
      width: 100px;
      height: 100px;
      margin: 10px auto;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      cursor: grab;
      border: 1px solid #ddd;
      border-radius: 4px;
      transition: transform 0.2s;
    }

    .item:hover {
      transform: scale(1.05);
    }

    .sandbox {
      flex-grow: 1;
      position: relative;
      background: transparent;
      margin: 10px;
      border: 2px solid #aaa;
      border-radius: 8px;
      overflow: hidden;
      user-select: none;
    }

    .object {
      position: absolute;
      width: 100px;
      height: 100px;
      cursor: pointer;
      z-index: 1;
      transition: box-shadow 0.2s;
    }

    .object img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
    }

    .object.selected {
      outline: 2px solid #3367d6;
      box-shadow: 0 0 8px #3367d6;
    }

    #export-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #4f93ff, #3367d6);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      z-index: 11000;
      user-select: none;
    }

    #export-btn:hover {
      background: linear-gradient(135deg, #5aa0ff, #3c73e6);
    }

    #selection-rect {
      position: absolute;
      border: 2px dashed #3399ff;
      background-color: rgba(51, 153, 255, 0.2);
      pointer-events: none;
      display: none;
      z-index: 9999;
    }

    #context-menu {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 10000;
      border-radius: 6px;
      min-width: 140px;
      font-family: 'Kokonor', sans-serif;
      user-select: none;
    }

    #context-menu button {
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: none;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }

    #context-menu button:hover {
      background: #3367d6;
      color: white;
    }

    .copyright {
      position: absolute;
      bottom: 10px;
      right: 30px;
    }

    a {
      display: inline-block;
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }

    a:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }
  </style>
</head>

<body>
  <div class="sidebar" id="sidebar"></div>
  <div class="sandbox" id="sandbox"></div>
  <button id="export-btn">Export</button>
  <p class="copyright"><a href="https://github.com/cs-sandtray/sand-tray" target="_blank">Github Repo</a></p>

  <div id="selection-rect"></div>
  <div id="context-menu">
    <button data-action="bring-forward">向前一层</button>
    <button data-action="send-backward">向后一层</button>
    <button data-action="delete">删除</button>
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const sandbox = document.getElementById('sandbox');
    const exportBtn = document.getElementById('export-btn');
    const selectionRect = document.getElementById('selection-rect');
    const contextMenu = document.getElementById('context-menu');
    let elements = [];
    let selectionStart = null;
    let selectedObjects = new Set();

    // 初始化移动组件
    const mover = new Moveable(document.body, {
      target: [],
      draggable: true,
      rotatable: true,
      resizable: true,
      throttleResize: 0,
      throttleRotate: 0,
      dragControlBox: true,
      edge: true,
      keepRatio: false,
      origin: false,
      snappable: true,
      pinchable: true,
      scalable: true,
      renderDirections: ["nw", "ne", "sw", "se", "n", "s", "e", "w"]
    })
      .on('drag', ({ target, left, top }) => {
        target.style.left = `${left}px`;
        target.style.top = `${top}px`;
      })
      .on('rotate', ({ target, beforeRotate }) => {
        const scale = target.dataset.scale || 1;
        target.style.transform = `rotate(${beforeRotate}deg) scale(${scale})`;
        target.dataset.rotation = beforeRotate;
      })
      .on('resize', ({ target, width, height, drag }) => {
        target.style.width = `${width}px`;
        target.style.height = `${height}px`;
        target.style.left = `${drag.beforeTranslate[0]}px`;
        target.style.top = `${drag.beforeTranslate[1]}px`;
      });

    // 获取所有的元素
    fetch('/api/get_elements')
      .then(res => res.json())
      .then(data => {
        elements = data;
        data.forEach(i => {
          const d = document.createElement('div');
          d.className = 'item';
          d.draggable = true;
          d.dataset.src = `/static/elements/${i.pic_name}`;
          d.style.backgroundImage = `url('${d.dataset.src}')`;
          sidebar.appendChild(d);
          d.addEventListener('dragstart', e =>
            e.dataTransfer.setData('text/plain', i.pic_name)
          );
        });
      });

    // 从待选列表中拖出来
    sandbox.addEventListener('dragover', e => e.preventDefault());
    sandbox.addEventListener('drop', e => {
      e.preventDefault();
      const pic_name = e.dataTransfer.getData('text/plain');
      const rect = sandbox.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const img = new Image();
      img.src = `/static/elements/${pic_name}`;
      img.onload = () => {
        const aspectRatio = img.width / img.height;
        const maxSize = 120;

        let width, height;
        if (aspectRatio > 1) {
          width = maxSize;
          height = maxSize / aspectRatio;
        } else {
          height = maxSize;
          width = maxSize * aspectRatio;
        }

        const obj = document.createElement('div');
        obj.className = 'object';
        obj.style.left = `${x - width / 2}px`;
        obj.style.top = `${y - height / 2}px`;
        obj.style.width = `${width}px`;
        obj.style.height = `${height}px`;
        obj.dataset.rotation = 0;
        obj.style.zIndex = 1000;
        obj.style.backgroundImage = `url('/static/elements/${pic_name}')`;
        obj.style.backgroundRepeat = "no-repeat";
        obj.style.backgroundSize = "100% 100%";
        obj.style.backgroundPosition = "center";
        obj.setAttribute("pic_name", pic_name);

        sandbox.appendChild(obj);
        select(obj);
      };
    });

    // 被激活 (选择)
    function select(el) {
      mover.target = el;
      sandbox.querySelectorAll('.object').forEach(o => o.classList.remove('selected'));
      selectedObjects.clear();
      el.classList.add('selected');
      selectedObjects.add(el);
    }

    sandbox.addEventListener('mousedown', e => {
      if (e.button !== 0 || e.target !== sandbox) return;
      selectionStart = { x: e.clientX, y: e.clientY };
      selectionRect.style.left = e.clientX + 'px';
      selectionRect.style.top = e.clientY + 'px';
      selectionRect.style.width = '0px';
      selectionRect.style.height = '0px';
      selectionRect.style.display = 'block';

      selectedObjects.clear();
      sandbox.querySelectorAll('.object').forEach(o => o.classList.remove('selected'));

      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);

      e.preventDefault();
    });

    function onMouseMove(e) {
      if (!selectionStart) return;
      const x = Math.min(e.clientX, selectionStart.x);
      const y = Math.min(e.clientY, selectionStart.y);
      const w = Math.abs(e.clientX - selectionStart.x);
      const h = Math.abs(e.clientY - selectionStart.y);
      selectionRect.style.left = x + 'px';
      selectionRect.style.top = y + 'px';
      selectionRect.style.width = w + 'px';
      selectionRect.style.height = h + 'px';
    }

    function onMouseUp(e) {
      if (!selectionStart) return;
      const rect = selectionRect.getBoundingClientRect();
      sandbox.querySelectorAll('.object').forEach(o => {
        const oRect = o.getBoundingClientRect();
        const ox = oRect.left + oRect.width / 2;
        const oy = oRect.top + oRect.height / 2;
        if (ox >= rect.left && ox <= rect.right && oy >= rect.top && oy <= rect.bottom) {
          o.classList.add('selected');
          selectedObjects.add(o);
        }
      });
      mover.target = selectedObjects.size === 1 ? [...selectedObjects][0] : [];
      selectionRect.style.display = 'none';
      selectionStart = null;
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('mouseup', onMouseUp);
    }

    sandbox.addEventListener('mousedown', e => {
      if (e.target === sandbox) {
        mover.target = [];
        selectedObjects.clear();
        sandbox.querySelectorAll('.object').forEach(o => o.classList.remove('selected'));
      }
    });

    sandbox.addEventListener('mousedown', e => {
      const obj = e.target.closest('.object');
      if (obj) {
        if (e.ctrlKey || e.shiftKey) {
          if (selectedObjects.has(obj)) {
            obj.classList.remove('selected');
            selectedObjects.delete(obj);
          } else {
            obj.classList.add('selected');
            selectedObjects.add(obj);
          }
          mover.target = [];
        } else {
          selectedObjects.clear();
          sandbox.querySelectorAll('.object').forEach(o => o.classList.remove('selected'));
          obj.classList.add('selected');
          selectedObjects.add(obj);
          mover.target = obj;
        }
      }
    });

    sandbox.addEventListener('contextmenu', e => {
      if (e.target.closest('.object')) {
        e.preventDefault();
        const obj = e.target.closest('.object');
        if (!selectedObjects.has(obj)) {
          selectedObjects.clear();
          sandbox.querySelectorAll('.object').forEach(o => o.classList.remove('selected'));
          obj.classList.add('selected');
          selectedObjects.add(obj);
          mover.target = obj;
        }
        contextMenu.style.left = e.clientX + 'px';
        contextMenu.style.top = e.clientY + 'px';
        contextMenu.style.display = 'block';
      } else {
        contextMenu.style.display = 'none';
      }
    });

    contextMenu.addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      const action = e.target.dataset.action;
      contextMenu.style.display = 'none';
      selectedObjects.forEach(obj => {
        switch (action) {
          case 'bring-forward': bringForward(obj); break;
          case 'send-backward': sendBackward(obj); break;
          case 'delete': obj.remove(); break;
        }
      });
      mover.target = [];
      selectedObjects.clear();
    });

    document.addEventListener('click', e => {
      if (!contextMenu.contains(e.target)) {
        contextMenu.style.display = 'none';
      }
    });

    function bringForward(el) {
      let z = parseInt(el.style.zIndex || 0);
      z = Math.min(z + 1, 1000);
      el.style.zIndex = z;
    }
    function sendBackward(el) {
      let z = parseInt(el.style.zIndex || 0);
      z = Math.max(z - 1, 0);
      el.style.zIndex = z;
    }

    exportBtn.addEventListener('click', () => {
      const arr = [];
      sandbox.querySelectorAll('.object').forEach(el => {
        arr.push({
          imageSrc: el.getAttribute('pic_name'),
          left: parseFloat(el.style.left),
          top: parseFloat(el.style.top),
          width: parseFloat(el.offsetWidth),
          height: parseFloat(el.offsetHeight),
          rotation: parseFloat(el.dataset.rotation || 0),
          zIndex: parseInt(el.style.zIndex || 0),
        });
      });
      captureDiv()
      alert(JSON.stringify(arr, null, 2));
    });
  </script>
  <script>
    function captureDiv() {
      html2canvas(sandbox).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        console.log(imgData)
      });
    }
  </script>
</body>

</html>